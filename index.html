<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GPS History Tool</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

:root{--panel:#ffffffcc;}

/* ===== GLOBAL ===== */

html,body{
  margin:0;
  height:100%;
  font-family:Inter,system-ui,Arial;
  overflow:hidden;
  background:
    radial-gradient(circle at 20% 20%, #e0e7ff 0%, transparent 40%),
    radial-gradient(circle at 80% 80%, #dbeafe 0%, transparent 40%),
    linear-gradient(180deg,#f8fafc,#eef2ff);
}

#app{
  display:flex;
  height:100%;
}

/* ===== LEFT PANEL ===== */

#left{
  width:320px;
  min-width:280px;
  max-width:560px;
  backdrop-filter:blur(14px);
  background:var(--panel);
  box-shadow:4px 0 20px rgba(0,0,0,.06);
  padding:8px;
  display:flex;
  flex-direction:column;
  gap:6px;
  user-select:none;
  font-size:12px;
}

/* ===== DIVIDER ===== */

#divider{
  width:6px;
  cursor:col-resize;
  background:linear-gradient(#c7d2fe,#818cf8,#c7d2fe);
}

/* ===== MAP ===== */

#mapWrap{
  flex:1;
  position:relative;
}

#map{
  height:100%;
}

#mapStyle{
  position:absolute;
  top:10px;
  right:10px;
  backdrop-filter:blur(10px);
  background:#ffffffcc;
  padding:6px 8px;
  border-radius:10px;
  z-index:999;
  font-size:11px;
}

/* ===== TEXTAREA ===== */

textarea{
  width:96%;
  height:76px;
  border-radius:8px;
  border:1px solid #e5e7eb;
  padding:5px;
  font-family:monospace;
  font-size:11px;
  resize:none;
  background:rgba(255,255,255,.6);
}

/* ===== BUTTON ===== */

button{
  padding:6px 8px;
  border:none;
  border-radius:9px;
  background:#2563eb;
  color:white;
  font-weight:600;
  font-size:12px;
  cursor:pointer;
}

button:hover{
  background:#1d4ed8;
}

/* ===== HEADING ===== */

h3{
  font-size:10px;
  color:#64748b;
  text-transform:uppercase;
  margin:3px 0;
}

/* ===== CARD ===== */

.card{
  background:rgba(255,255,255,.75);
  backdrop-filter:blur(10px);
  border:1px solid rgba(0,0,0,.05);
  border-radius:12px;
  padding:6px;
  display:flex;
  flex-direction:column;
  gap:4px;
}

/* ===== SLIDER ===== */

.slider-container{
  position:relative;
  width:100%;
  height:6px;
  background:#bfc6d4;
  border-radius:999px;
  margin:5px 0 8px;
}

.slider-progress{
  position:absolute;
  height:100%;
  background:linear-gradient(90deg,#2563eb,#60a5fa);
  border-radius:999px;
}

.slider-thumb-glass{
  position:absolute;
  top:50%;
  transform:translate(-50%,-50%);
  width:26px;
  height:16px;
  border-radius:999px;
  cursor:pointer;
  background:rgba(255,255,255,.7);
  backdrop-filter:blur(6px);
  border:1px solid rgba(255,255,255,.6);
  box-shadow:0 3px 8px rgba(0,0,0,.25);
  transition:.15s;
}

/* ===== LEAFLET ===== */

.leaflet-interactive{
  transition:stroke-width .15s ease;
}

/* ===== DRAG & DROP OVERLAY ===== */

#dropOverlay{
  position:fixed;
  inset:0;
  background:rgba(30,41,59,.75);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

#dropOverlay.active{
  display:flex;
}

#dropOverlay div{
  font-size:36px;
  font-weight:800;
  letter-spacing:2px;
  color:white;
  padding:32px 48px;
  border:4px dashed rgba(255,255,255,.7);
  border-radius:22px;
}

/* ===== CUSTOM FILE INPUT ===== */

#fileBtn{
  background:#2563eb;
  color:white;
  font-weight:600;
  border-radius:9px;
  padding:6px 8px;
  font-size:12px;
  cursor:pointer;
}

#fileBtn:hover{
  background:#1d4ed8;
}

#fileName{
  font-size:10px;
  color:#475569;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

</style>

</head>

<body>

<div id="dropOverlay">
  <div>DROP CSV FILE HERE</div>
</div>

<div id="app">

<div id="left">

<h3>Input Excel (longitude, latitude)</h3>
<textarea id="input" placeholder="Just paste here from excel table, example:
106,849176	-6,147265
106,848928	-6,145941
106,84873	-6,144903
"></textarea>

<button onclick="process()">Proceed</button>

<div class="card">
  <button type="button" id="fileBtn">Browse CSV File</button>
  <div id="fileName">No file selected</div>
  <input type="file" id="csvFile" accept=".csv,.xlsx" hidden>
</div>

<div class="card" id="pickerCard" style="display:none">
  <label>Sheet</label>
  <select id="sheetSelect"></select>

  <label>Latitude Column</label>
  <select id="latSelect"></select>

  <label>Longitude Column</label>
  <select id="lonSelect"></select>

</div>

<h3>Output</h3>
<textarea id="output" readonly></textarea>
<button onclick="plot()">Plot</button>

<div class="card">
<label><input type="checkbox" id="showPath" checked onchange="updateStyle()"> Show The Line</label>
<label>The Thickness of the Line: <span id="wval">4</span></label>

<div class="slider-container" data-target="weight" data-min="1" data-max="60" data-value="4">
<div class="slider-progress"></div>
<div class="slider-thumb-glass"></div>
</div>

<label>Line Color</label>
<input type="color" id="color" value="#ff0000" oninput="updateStyle()">
</div>

<div class="card">
<label><input type="checkbox" id="showPoints" checked onchange="updateStyle()"> Show Dot Point</label>
<label>Dot Size: <span id="pval">5</span></label>

<div class="slider-container" data-target="pointSize" data-min="1" data-max="30" data-value="5">
<div class="slider-progress"></div>
<div class="slider-thumb-glass"></div>
</div>

<label>Dot Color</label>
<input type="color" id="pointColor" value="#0000ff" oninput="updateStyle()">
</div>

<button onclick="clearAll()">Clear</button>

</div>

<div id="divider"></div>

<div id="mapWrap">
<div id="mapStyle">
<label><input type="radio" name="bm" checked onchange="setMap('osm')"> OSM</label>
<label><input type="radio" name="bm" onchange="setMap('sat')"> Satellite</label>
</div>
<div id="map"></div>
</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>

let workbook = null;
let sheetRows = [];

/* ===== MAP & EXISTING LOGIC (TIDAK DIUBAH) ===== */

const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const esri=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
const map=L.map('map',{center:[-6.2,106.8],zoom:13,layers:[osm]});
const layer=L.layerGroup().addTo(map);

map.createPane('pointsPane');
map.getPane('pointsPane').style.zIndex = 650;
map.getPane('pointsPane').style.pointerEvents = 'auto';

let poly=null, points=[], coords=[];

function setMap(t){
  map.eachLayer(l=>map.removeLayer(l));
  (t==="sat"?esri:osm).addTo(map);
  layer.addTo(map);
}

const divider=document.getElementById("divider");
const left=document.getElementById("left");
let resizing=false;

divider.onmousedown=()=>resizing=true;
window.onmouseup=()=>resizing=false;

window.onmousemove=e=>{
  if(!resizing) return;
  left.style.width=Math.max(300,Math.min(600,e.clientX))+"px";
  map.invalidateSize();
};

function normalizeCoord(v){
  if(!v) return null;

  v = v.toString().trim();

  const parts = v.split(".");
  if(parts.length === 3){
    return parseFloat(parts[0] + "." + parts[1] + parts[2]);
  }

  return parseFloat(v.replace(",","."));
}

function clean(v){
  return normalizeCoord(v);
}


function process(){
  let c=1,out=[];
  input.value.split('\n').forEach(l=>{
    if(!l) return;
    let p=l.trim().split(/\s+/);
    out.push(c+"."+clean(p[1])+","+clean(p[0]));
    c++;
  });
  output.value=out.join("\n");
}

const startIcon = L.divIcon({
  className:"",
  html:`
  <svg width="40" height="40" viewBox="0 0 40 40">
    <!-- pole -->
    <rect x="6" y="2" width="3" height="36" fill="#065f46"/>
    <!-- flag -->
    <path d="M9 4 
             C22 6, 26 12, 36 10
             L36 22
             C26 24, 22 18, 9 20 Z"
          fill="#22c55e"
          stroke="#065f46"
          stroke-width="1.5"/>
  </svg>
  `,
  iconSize:[40,40],
  iconAnchor:[6,38]
});

const finishIcon = L.divIcon({
  className:"",
  html:`
  <svg width="40" height="40" viewBox="0 0 40 40">
    <!-- pole -->
    <rect x="6" y="2" width="3" height="36" fill="#111"/>
    <!-- checkered flag -->
    <g transform="translate(9,4)">
      <rect x="0" y="0" width="24" height="18" fill="#fff"/>
      <!-- black squares -->
      <rect x="0" y="0" width="6" height="6" fill="#000"/>
      <rect x="12" y="0" width="6" height="6" fill="#000"/>
      <rect x="6" y="6" width="6" height="6" fill="#000"/>
      <rect x="18" y="6" width="6" height="6" fill="#000"/>
      <rect x="0" y="12" width="6" height="6" fill="#000"/>
      <rect x="12" y="12" width="6" height="6" fill="#000"/>
      <rect x="24" y="0" width="4" height="18" fill="#000"/>
    </g>
  </svg>
  `,
  iconSize:[40,40],
  iconAnchor:[6,38]
});

function plot(){
  coords=[];
  output.value.split('\n').forEach(l=>{
    l=l.replace(/^\d+\./,'');
    if(!l) return;
    let p=l.split(',');
    coords.push([+p[0],+p[1]]);
  });

  layer.clearLayers(); 
  points=[];

  poly=L.polyline(coords).addTo(layer);

  // START & FINISH MARKER
  if(coords.length){
    L.marker(coords[0],{icon:startIcon}).addTo(layer);
    L.marker(coords[coords.length-1],{icon:finishIcon}).addTo(layer);
  }

  // DOT POINTS (MID ONLY)
  coords.forEach((c,i)=>{
    if(i===0 || i===coords.length-1) return;
    points.push(L.circleMarker(c,{pane:'pointsPane'}).addTo(layer));
  });

  map.fitBounds(poly.getBounds());
  updateStyle();
}

function updateStyle(){
  if(!poly) return;

  if(showPath.checked){
    poly.setStyle({color:color.value,weight:+weight.value});
    layer.addLayer(poly);
  }else layer.removeLayer(poly);

  points.forEach(p=>{
    if(showPoints.checked){
      p.setRadius(+pointSize.value);
      p.setStyle({color:pointColor.value,fillColor:pointColor.value,fillOpacity:1});
      layer.addLayer(p);
    }else layer.removeLayer(p);
  });
}

function clearAll(){
  layer.clearLayers();
  poly=null;
  points=[];
  coords=[];

  input.value="";
  output.value="";
  csvFile.value="";
  fileName.innerText="No file selected";

  pickerCard.style.display="none";

  map.setView([-6.2,106.8],13);
}


/* ===== CSV PARSER (BARU) ===== */

function parseCSV(file){
  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    complete:r=>{

      const keys = Object.keys(r.data[0]||{}).map(k=>k.toLowerCase());

      const latKey = keys.find(k=>k.includes("lat"));
      const lonKey = keys.find(k=>k.includes("lon") || k.includes("lng"));

      let out=[],c=1;

      r.data.forEach(row=>{
        const lat = normalizeCoord(row[latKey]);
        const lon = normalizeCoord(row[lonKey]);

        if(!lat || !lon) return;

        out.push(`${c}.${lat},${lon}`);
        c++;
      });

      output.value=out.join("\n");
    }
  });
}

csvFile.onchange=e=>{
  if(e.target.files[0]) parseCSV(e.target.files[0]);
};

const fileBtn = document.getElementById("fileBtn");
const fileName = document.getElementById("fileName");

fileBtn.onclick = () => csvFile.click();

csvFile.onchange = e => {
  const file = e.target.files[0];
  if(!file) return;

  fileName.innerText = file.name;

  const ext = file.name.split('.').pop().toLowerCase();

  if(ext === "csv"){
    parseCSV(file);
  }else if(ext === "xlsx"){
    parseXLSX(file);
  }else{
    alert("Unsupported file format");
  }
};

function parseXLSX(file){
  const reader=new FileReader();

  reader.onload=e=>{
    const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
    workbook=wb;

    sheetSelect.innerHTML="";
    wb.SheetNames.forEach(n=>{
      sheetSelect.innerHTML+=`<option>${n}</option>`;
    });

    pickerCard.style.display="block";
    loadSheet();
  };

  reader.readAsArrayBuffer(file);
}

sheetSelect.onchange=loadSheet;

function loadSheet(){

  const sheet = workbook.Sheets[sheetSelect.value];
  sheetRows = XLSX.utils.sheet_to_json(sheet,{defval:""});

  if(!sheetRows.length) return;

  latSelect.innerHTML="";
  lonSelect.innerHTML="";

  Object.keys(sheetRows[0]).forEach(k=>{

    const o1=document.createElement("option");
    o1.value=k;
    o1.textContent=k;
    latSelect.appendChild(o1);

    const o2=document.createElement("option");
    o2.value=k;
    o2.textContent=k;
    lonSelect.appendChild(o2);
  });

  // auto detect
  Object.keys(sheetRows[0]).forEach((k,i)=>{
    if(k.toLowerCase().includes("lat")) latSelect.selectedIndex=i;
    if(k.toLowerCase().includes("lon")) lonSelect.selectedIndex=i;
  });

  processSheet();
}

latSelect.onchange = processSheet;
lonSelect.onchange = processSheet;


function processSheet(){

  const latCol = latSelect.value;
  const lonCol = lonSelect.value;

  let out=[],c=1;

  sheetRows.forEach(r=>{
    const lat = normalizeCoord(r[latCol]);
    const lon = normalizeCoord(r[lonCol]);

    if(isNaN(lat)||isNaN(lon)) return;

    out.push(`${c}.${lat},${lon}`);
    c++;
  });

  output.value=out.join("\n");
}


/* ===== GLOBAL DRAG & DROP ===== */

const overlay=document.getElementById("dropOverlay");
let dragCount=0;

window.addEventListener("dragenter",e=>{
  e.preventDefault();
  dragCount++;
  overlay.classList.add("active");
});

window.addEventListener("dragover",e=>e.preventDefault());

window.addEventListener("dragleave",e=>{
  dragCount--;
  if(dragCount<=0){
    overlay.classList.remove("active");
    dragCount=0;
  }
});

window.addEventListener("drop",e=>{
  e.preventDefault();
  overlay.classList.remove("active");
  dragCount=0;

  const f = e.dataTransfer.files[0];
  if(!f) return;

  fileName.innerText = f.name;

  const ext = f.name.split('.').pop().toLowerCase();

  if(ext === "csv"){
    parseCSV(f);
  }else if(ext === "xlsx"){
    parseXLSX(f);
  }
});


/* ===== SLIDER (TIDAK DIUBAH) ===== */

document.querySelectorAll('.slider-container').forEach(s=>{
  const thumb=s.querySelector('.slider-thumb-glass');
  const prog=s.querySelector('.slider-progress');
  const min=+s.dataset.min,max=+s.dataset.max;
  let val=+s.dataset.value;

  function render(){
    const pct=(val-min)/(max-min)*100;
    prog.style.width=pct+"%";
    thumb.style.left=pct+"%";
    if(s.dataset.target==="weight"){window.weight={value:val};wval.innerText=val;}
    if(s.dataset.target==="pointSize"){window.pointSize={value:val};pval.innerText=val;}
    updateStyle();
  }
  render();

  let drag=false;
  thumb.onmousedown=()=>drag=true;
  window.addEventListener("mouseup",()=>drag=false);
  window.addEventListener("mousemove",e=>{
    if(!drag) return;
    const r=s.getBoundingClientRect();
    val=Math.round(min+Math.min(Math.max(0,e.clientX-r.left),r.width)/r.width*(max-min));
    render();
  });
});

</script>
</body>
</html>
